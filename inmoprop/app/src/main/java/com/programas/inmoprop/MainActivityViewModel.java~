package com.programas.inmoprop;

import static android.content.Context.SENSOR_SERVICE;
import static com.programas.inmoprop.request.ApiClient.getApiInmobiliaria;

import android.Manifest;
import android.app.Application;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.hardware.Sensor;
import android.hardware.SensorEvent;
import android.hardware.SensorEventListener;
import android.hardware.SensorManager;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;
import android.widget.Toast;

import androidx.annotation.NonNull;
import androidx.core.app.ActivityCompat;
import androidx.lifecycle.AndroidViewModel;
import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import com.google.gson.Gson;
import com.programas.inmoprop.modelos.Propietario;
import com.programas.inmoprop.request.ApiClient;

import java.io.Serializable;
import java.util.List;


import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

public class MainActivityViewModel extends AndroidViewModel {
    private MutableLiveData<String> mMensaje;
    private int contador = 0;
    private Context context;
    private SensorManager sm;
    private List<Sensor> sensores;
    private ManejaSensores manejasensor;
    private float aceleracionactual;
    private float aceleracionanterior;

    public LiveData<String> getmMensaje() {
        if (mMensaje == null) {
            mMensaje = new MutableLiveData<>();
        }
        return mMensaje;
    }

    public MainActivityViewModel(@NonNull Application application) {
        super(application);
        context = application.getApplicationContext();
    }
    public void setmMensaje() {
        mMensaje.setValue("Cantidad de veces que hizo click: " + contador++);
    }
    public void loginToken(String usuario, String clave){
        ApiClient.InmmobiliariaSetvice api= getApiInmobiliaria();
        Call<String>llamada= api.login(usuario,clave);

        llamada.enqueue(new Callback<String>() {
            @Override
            public void onResponse(Call<String> call, Response<String> response) {
                if (response.isSuccessful()) { //pregunto si la respuesta es satisfactoria
                    mMensaje.postValue("Bienvenido ");

                    String token=response.body();
                    ApiClient.setToken(context,"Bearer "+token);
                    Log.d("tokenobtenido",token);

                    Intent intent = new Intent(context, MenuActivity.class);

                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
                    context.startActivity(intent);
                    //

                } else {
                    mMensaje.postValue("Usuario y/o contraseña Incorrecta; reintente");
                }
            }

            @Override
            public void onFailure(Call<String> call, Throwable t) {
                mMensaje.postValue("Error de Servidor");
            }

    }
        );
    }

    /// sensor agitar para llamar
    public void activarSensor(){
        //TODO
        sm= (SensorManager) getApplication().getSystemService(SENSOR_SERVICE);
        //sensores=sm.getSensorList(Sensor.TYPE_ACCELEROMETER);
        sensores=sm.getSensorList(Sensor.TYPE_ACCELEROMETER);
        manejasensor=new ManejaSensores();
        sm.registerListener(manejasensor,sensores.get(0),SensorManager.SENSOR_DELAY_NORMAL);
        aceleracionactual=sm.GRAVITY_EARTH;
        aceleracionanterior=sm.GRAVITY_EARTH;
   }
    public void desactivarSensor() {
        sm.unregisterListener(manejasensor);
    }

    private class ManejaSensores implements SensorEventListener {
        @Override
        public void onAccuracyChanged(Sensor sensor, int i) {//el metodo se invoca cuando cambia la exactitud del sensor
        }

        @Override
        public void onSensorChanged(SensorEvent sensorEvent) {//el metodo se ejecuta caundo el sensor emite notificación (ejemplo: nueva lectura)
            float x=sensorEvent.values[0];
            float y=sensorEvent.values[1];
            float z=sensorEvent.values[2];

            aceleracionanterior=aceleracionactual;
            aceleracionactual= (float) Math.sqrt(x*x+y*y+z*z);// calculo la raiz cuadrada de un numero combinando ejes xyz para sacar la magnitud
            //teorema pitagoras formula mag=raiz(x^2+y^2+z^2)
            float diferenciaaceleracion=aceleracionactual-aceleracionanterior;

            if (diferenciaaceleracion>5){//graduo la sensibilidad de la magnitud del agitación, mientra mas grande sea el numero menos sensibiliad va a tener
                llamarInmobiliaria();
            }
        }
    }

    private void llamarInmobiliaria(){
        String telefonoinmobilaria="111";
        Intent intent=new Intent(Intent.ACTION_CALL);
        intent.setData(Uri.parse("tel:"+telefonoinmobilaria));
        if (ActivityCompat.checkSelfPermission(context, Manifest.permission.CALL_PHONE)
                != PackageManager.PERMISSION_GRANTED) {
            mMensaje.postValue("No tienes permiso para llamar");
            return;
        }
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        context.startActivity(intent);
        desactivarSensor();
    }

}

